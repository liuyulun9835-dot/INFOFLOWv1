# 事件波动性回测规则文档 L4_V3

## 1. 概述
L4_V3 版本在保持既有信息流语义一致性的前提下，对 5min 阈值进行了软放宽，并新增 1min 级别的短窗验证模块，旨在在不破坏事件语义纯度的前提下，提升样本覆盖度与统计稳健性。

该版本主要解决：
- **L4@5min 样本不足**导致的显著性验证偏差；
- **L4@15min、1h 聚合噪音问题**造成的效应量稀释；
- **事件触发过于稀疏**带来的回测不稳定性。

## 2. 测试目标
1. 验证 L4 事件语义在扩大样本后的稳健性：
   - Cliff’s δ 中位数应 ≥ 0.30；
   - FDR 修正后显著事件占比 ≥ 30%；
2. 检查 L4@1min 与 L4@5min 的事件分布相似性：
   - 结构保持（事件频率比例近似一致）；
   - 高效应事件的类别一致率 ≥ 60%。
3. 对比 L4 与 L2（15min）在不同时间窗口下的跨层效应：
   - L4 在短窗（1m、5m）应表现为**信息释放与衰减循环**；
   - L2 在中窗（15m）表现为**能量积聚与扩散模式**。

## 3. 数据与时间尺度设置
- **时间尺度**：1min、5min、15min。
- **输入数据路径**：
  - TL 源：`C:\Users\69557\OrderFlow-V6\data\stats\tradinglite\<tf>`
  - PX 源：`C:\Users\69557\OrderFlow-V6\data\exchange\BTCUSDT`
- **文件命名**：
  - 1min: `1m_Line_0.csv` / `1m_Line_1.csv` / `1m_Line_2.csv`
  - 5min: `5m_Line_0.csv` / `5m_Line_1.csv` / `5m_Line_2.csv`
- **回测产物**：`events_l4.parquet`、`rv_stats.csv`、`kw_results_l4.csv`。

## 4. 阈值与参数调整（L4@5min）
| 原子 | 参数名 | 原设定 | 调整后 | 备注 |
|------|--------|---------|----------|------|
| E_Burst | z_star | 0.75 | [0.60, 1.30] | 能量突发放宽 |
| RegimeSwitch | df_thr | 0.85 分位 | 0.75–0.80 分位 | 主峰跃迁放宽 |
| I_CoUp | dgamma_thr | 70% 分位 | ×0.85 | 相干增幅放宽 |
| Latent | lowband_tau | 2 | 1 | 低频占比放宽 |
| Overload | z_I_high | 1.5 | ×0.9，最低1.1 | 避免过载误检 |
| Decay | 逻辑 | (PhaseSlip & E_Trough & RegimeSwitch) | (PhaseSlip \| E_Trough) & RegimeSwitch | 修正逻辑结构 |

**目标样本密度**：每万窗触发数 80–160。

## 5. 新增 L4@1min 模块
### 5.1 参数设定
| 参数 | 值 | 说明 |
|------|----|------|
| corr_win | 48–64 | 防止短周期噪动放大 |
| z_star | 0.70–1.30 | 与5min相近，略偏紧 |
| within_T | 12–16 | 保留数分钟耦合窗 |
| target_band | 120–240 | 样本扩大区间 |
| H_LIST_BARS | [3, 6, 12] | 与 5min 同口径 |

### 5.2 样本处理逻辑
- 不复采样 1min 价格序列，直接对齐。
- 事件逻辑与 L4@5min 保持一致。
- L2 特征仅供内部计算，不输出文件。

## 6. L2 流程调整
- **仅保留 15min L2 回测与特征输出**。
- **1min / 5min**：仅在内存中计算 L2 特征以支持 L4 原子，不落地写盘。
- **1h 时间级**完全删除。

## 7. 测试方法
1. **事件提取与标注**：
   - 使用 `event_rules_l4()` 在不同时间尺度上触发四类事件：Release、Overload、Decay、Latent。
2. **收益窗口设定**：
   - H = [3,6,12] bars；以未来波动率（RV）为主要响应变量。
3. **统计检验**：
   - KW 检验（α=0.05），多组比较。
   - Mann–Whitney U + FDR 修正。
   - Cliff’s δ 计算效应量。
4. **显著性标准**：
   - p_adj < 0.05；|δ| ≥ 0.30 视为中等效应，≥0.50 视为强效应。
5. **输出汇总**：
   - `kw_results_l4.csv`：统计显著性结果；
   - `effect_size.csv`：效应量；
   - `qc_summary.txt`：自动报告生成。

## 8. 语义结构与信息流解释
### 8.1 四类事件语义（5min 为主）
1. **Release（释放）**：能量密集释放与相干上升同步出现，标志市场结构由稳定转向过载。
2. **Overload（过载）**：高 ICI 极值与短期结构同步叠加，表现为信息过度同向集中。
3. **Decay（衰减）**：结构跃迁后相干破裂或能量塌陷，信息流进入松散分布区。
4. **Latent（潜伏）**：低频能量占比上升，系统恢复平衡但仍保留潜在动能。

### 8.2 信息流循环（示意）
```
Release → Overload → Decay → Latent → (再释放)
```
- 表征市场信息在能量—相干双轴下的周期流动：
  - **Release**：突发信号 → **Overload**：系统过载 → **Decay**：信号破裂 → **Latent**：潜在积蓄。
- L4 层事件反映信息场内部的“结构波动”，而非价格方向性行为。

## 9. 稳健性验证指标
| 指标 | 目标值 | 说明 |
|--------|----------|------|
| 事件样本数 | ≥30 / 类 | KW 检验可行性下限 |
| Cliff’s δ 中位 | ≥0.30 | 中等效应量阈值 |
| 显著对占比 | ≥30% | FDR 校正后显著事件比例 |
| L4/L2 对齐率 | ≥60% | 跨层语义一致性 |

## 10. 输出验证与版本管理
- **版本号**：L4_V3（2025.10）
- **生成路径**：`data\stats\backtest\infoflow_regimes_final\l4_v3`。
- **文件签名**：
  - `signature.json.l4_v3`：记录参数集与采样区间。
  - `summary_l4_v3.txt`：自动生成总结报告。

## 11. 附录：信息流语义循环图
```
        +-------------+
        |   Release   |
        +-------------+
               |
               v
        +-------------+
        |  Overload   |
        +-------------+
               |
               v
        +-------------+
        |    Decay    |
        +-------------+
               |
               v
        +-------------+
        |   Latent    |
        +-------------+
               |
               v
          (循环再启)
```

---
**版本备注**：
- L4_V3 属于“软放宽 + 样本扩容”版本；
- 重点在于扩大统计覆盖、检验语义稳健性，不涉及方向性信号扩展；
- 后续如需进行 L5 级别建模，可直接沿用该语义与测试框架。

