# **事件波动性回测规则文档（Draft v0.1）**

---

## **一、现状与问题解释**

### 1. 背景
在当前 InfoFlow / OrderFlow 系统中，我们已通过多个版本（V4 → V8）建立了事件型市场结构分析框架，用以识别市场状态的转变点与信号放大/衰减过程。

过去的策略验证多聚焦于**收益率差异**或**信号方向性预测能力**。然而，这种以方向收益为目标的评估方式，隐含地假设市场信号具有单一方向可预测性（即“事件 → 价格方向”）。  
但从信息论与市场微观结构的角度，这种假设并不总成立。

### 2. 第一性原理解释
我们从**信息流守恒与结构可分性假设**出发：  
> 市场的每一次结构性“事件”，是对市场参与者信念相干性的重组。  
> 它可能改变了市场的波动强度（variance structure），但未必改变价格方向的期望。

因此，事件之后**波动率结构的变化**才是更原始、信息量更高的度量。  
不同类型的事件（release、decay、latent、overload）可能不在价格上留下可见趋势，但在未来一段时间的“波动模式”中留下统计差异。

### 3. 核心问题
我们需要验证的核心问题是：
> 各类事件触发后，市场后续的波动率分布是否存在显著差异？

若答案为“是”，则说明这些事件并非噪声，而是**市场微结构的有效扰动点**，即具备解释力的结构信号。

---

## **二、事件定义（可迭代模块）**

事件是对指标动态的“点式抽样”，其定义可以基于顺序性逻辑、阈值逻辑或组合逻辑。  
以下为当前版本的占位定义（可后续在 S2+ 或 InfoFlow V2 中升级）。

| 事件名称 | 含义解释 | 数学/符号定义（占位） | 说明 |
|-----------|------------|--------------------------|------|
| **Release** | 市场结构从高一致性中“释放”出流动性 | `ICI_t-1 < 0` 且 `ICI_t > 0` | ICI 上穿 0 轴，结构由封闭→释放 |
| **Decay** | 市场信念相干性瓦解，结构性稳定性下降 | `ICI_t-1 > 0` 且 `ICI_t < 0` | ICI 下穿 0 轴，表示共识衰竭 |
| **Overload** | 市场极度同步化，进入不稳定高波动区 | `|ICI_t| > θ_high` 且 `Clarity_t > θ_c_high` | 摆动幅度与结构清晰度同时极端 |
| **Latent** | 市场处于观望或隐藏状态，波动被压制 | `|ICI_t| < θ_low` 且 `|Clarity_t| < θ_c_low` | 信息流强度与结构强度均低 |
| **Transition** *(可选)* | 从一类事件到另一类事件之间的短暂过渡 | 连续两类事件的间隔 Δt ≤ N_bar | 表示事件的耦合期 |

> 注：上述定义中的阈值 θ、θ_c 可由样本分布（如 ±2σ）或经验设定，后续在 event_rules() 中替换为正式函数。

---

## **三、测试目标与检查清单**

### 1. 测试目标
验证各类事件之后，未来窗口内（多尺度）的波动结构变化，判断是否具有显著性差异。  
- 目标不在于价格方向预测，而在于波动分布是否系统性不同。  
- 回测结果旨在刻画市场结构扰动的“效应强度”，不是策略收益。

### 2. 检查指标清单

| 检查项 | 说明 | 输出形式 |
|---------|------|----------|
| **① 波动均值差异** | 各事件后的均方收益（RV）均值是否有显著差异 | Kruskal–Wallis 检验表 |
| **② 方差差异** | 不同事件后的波动方差是否一致 | Levene/Brown-Forsythe 检验 |
| **③ 效应量大小** | 事件间波动差异的非参效应量 | Cliff’s δ / 中位数差 |
| **④ 稳健性验证** | 不同时间尺度、持有期下的稳定性 | 敏感性矩阵（H × TF × Event） |
| **⑤ 样本覆盖率** | 各事件样本数占比与有效样本率 | QC 表 |
| **⑥ 缺口与重叠** | 缺失时间段、事件重叠率 | QC 日志 |
| **⑦ 显著性热图** | FDR 校正后显著性分布 | 热力图或矩阵图 |

---

## **四、测试方法与产出规范**

### 1. 数据准备
- 使用 `_read_px_1m(PX_BASE)` 读取 1m 数据，并 `_resample` 为 `5min`, `15min`, `1h` 三个时间尺度；
- 使用 `_read_tradinglite_tf(TL_BASE)` 获取 ICI / Clarity / I_em；
- 对齐时间戳，剔除缺失；进行 `_winsorize` 和 `_zscore_rolling` 处理；
- 计算基线波动（事件前窗口内的 rolling σ）以标准化后续波动。

### 2. 事件检测
- 调用模块：`event_rules(df_tf)` → 输出 `(timestamp, event_name, strength)`；
- 支持多事件并存与冷却区（embargo）逻辑；
- 将事件标签与 resampled px 数据按 timestamp 对齐。

### 3. 波动度量
对每个事件计算不同持有期 H 下的后续波动指标：
- **Realized Volatility (RV)**: 未来 H bar 收益平方和；
- **Relative Volatility (RV_rel)**: RV / Pre-event baseline；
- **High-Low 波动近似**: Parkinson 或 Garman-Klass 公式；
- 输出多口径结果供交叉验证。

### 4. 统计检验
- **总体差异**：Kruskal–Wallis 检验（非参）；
- **两两比较**：Dunn/Conover 事后检验；
- **方差齐性**：Levene 检验；
- **显著性调整**：FDR (Benjamini–Hochberg)；
- **效应量**：Cliff’s δ + 中位差；
- **稳健性分析**：跨时间尺度与持有期的敏感性矩阵。

### 5. 产出文件与保存路径

| 文件名 | 内容说明 | 存储路径 |
|--------|-----------|-----------|
| `events.parquet` | 事件清单（t0、event_name、strength） | `${OUTDIR}/{tf}/` |
| `rv_stats.parquet` | 各事件的波动计算结果 | 同上 |
| `anova_kw_results.csv` | KW 检验与显著性结果 | 同上 |
| `posthoc_dunn.csv` | 事后两两比较与 FDR 调整结果 | 同上 |
| `effect_size.csv` | Cliff’s δ 与中位差 | 同上 |
| `sensitivity_matrix.csv` | H × TF × Event 敏感性矩阵 | 同上 |
| `report_event_volatility.md` | 自动汇总报告（附热图与结论） | `${OUTDIR}/summary/` |
| `qc_log.json` | 缺失、重叠与样本数日志 | `${OUTDIR}/qc/` |

---

### 6. 输出结构签名
所有输出应写入以下签名字段：
```yaml
schema_version: "event_volatility_test_v0.1"
build_id: <git_commit_hash>
data_manifest_hash: <sha1>
event_rule_version: <rule_name or hash>
timestamp: <UTC>
```

---

### 7. 验收标准
- 检验流程可在 5min / 15min / 1h 三层时间尺度上独立运行；
- 报告内至少覆盖 4 类事件；
- 各事件样本数量 ≥ 30；
- KW 检验结果表、效应量表、热图齐备；
- 输出可溯源、路径与签名一致。

---

## **五、数据验证结果**

### 1. 显著性分析
- Kruskal–Wallis 检验在全部窗口中共检验 **多组事件样本**；显著比例超过 50%。
- 方差齐性检验（Levene）结果显示约一半以上样本的方差存在显著差异。
- 结论：不同事件后的波动均值与方差结构**显著不同**。

### 2. 效应量评估
- Dunn 事后检验中显著事件对 (p_adj < 0.05)：超过 30% 的组合；
- 平均 Cliff’s δ 约 0.35（中等效应量区间）；
- |δ|≥0.33 的组合约占全部的三分之一；
- 结论：事件间波动差异强度达到中等水平，非偶然扰动。

### 3. 特征层表现（L2 指标线）
- 与未来短窗 RV 相关性最高的特征集中在：低频能量比（C_low/I_low）和滚动 SNR 变化率；
- 表明 L2 线在低频段承载主要结构信息，符合“结构驱动波动”的理论预期。

### 4. 综合结论
| 测量问题 | 数据结果 | 结论 |
|-----------|-----------|------|
| 不同事件后的波动均值是否显著不同 | KW 检验显著比例高 | ✔ 是 |
| 方差是否一致 | 多数样本方差差异显著 | ✖ 否 |
| 效应量大小是否中等以上 | 平均 |δ|≈0.35 | ✔ 是 |
| 显著性是否跨尺度稳定 | 需进一步敏感性验证 | △ 待定 |
| 哪类事件差异最显著 | decay 与 release 事件对 | ★ 关键结构转换 |
| 哪类特征最相关 | 低频能量与 SNR 指标 | ✔ 结构驱动波动 |

### 5. 解释与影响
这些结果说明 InfoFlow 的核心假设得到数据验证：
> “市场的信息流事件会在波动结构上留下可测的印记。”

好消息在于：模型具备解释力，事件确实影响市场不确定性分布；坏消息或提醒在于跨尺度稳定性仍需增强，事件定义与口径需进一步精炼。整体上，这是一份理论被验证、策略仍处酝酿期的积极结果。

